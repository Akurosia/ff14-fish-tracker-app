<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="A web version of the FF14 Fish Guide." />
    <meta name="author" content="Carbuncle Plushy (Balmung)" />

    <link rel="icon" type="image/png" href="favicon.png" />

    <title>FFX|V Fish Guide</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-142180509-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-142180509-1');
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dot/1.1.2/doT.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twix.js/1.1.5/twix.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.28.5/date_fns.min.js"></script>
    <script src="js/lib/dateFns.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.5.2/rxjs.umd.min.js"></script>

    <link rel="stylesheet" href="public/images/sprite.css" />
    <link rel="stylesheet" href="css/semantic_ui_overrides.css" />
    <link rel="stylesheet" href="css/overlay.css" />
    <link rel="stylesheet" href="css/dark_overlay.css" />

    <!-- Localization Support script -->
    <script type="text/javascript" src="js/app/localization.js"></script>
    <!-- Include the data -->
    <script type="text/javascript" src="js/app/data.js"></script>
    <script type="text/javascript" src="js/app/time.js"></script>
    <script type="text/javascript" src="js/app/weather.js"></script>

    <script type="text/javascript">
      var currentPage = 1;
      let MAX_PAGE = 30;
      let pageNumbers = _.range(1, MAX_PAGE + 1);
      let pageRange = 1;

      function initializeFishGuide() {
        // First, we need to assign events to the menu selector buttons.
        let pageSelector$ = $('#fishGuidePageSelector');
        let items = pageSelector$.children();
        items.on('click', function (e) {
          e.stopPropagation();
          let $this = $(this);

          // First off, is the button enabled?
          if ($this.hasClass('disabled')) {
            return;
          }

          // What page should we navigate to?
          let newPage = $this.data('num');

          // Display the new page now.
          displayFishGuidePage(newPage);
        });

        // Determine how many pages are necessary.
        MAX_PAGE = (_(DATA.FISH).keys().length / 25) >>> 0;
        pageNumbers = _.range(1, MAX_PAGE + 1);

        // Initialize the Fish Guide menu selector.
        displayFishGuidePage(1);
      }

      // Populate the fish guide grid and menu selector.
      function displayFishGuidePage(page) {
        // TODO: Move this up once this code is inside a class.
        let pageSelector$ = $('#fishGuidePageSelector');
        // [<<] [1] [...] [n-1] [n] [n+1] [...] [M] [>>]
        //          ^^^^^ ^^^^^     ^^^^^ ^^^^^
        //           n>2   n>1      M-n>1 M-n>2
        // Omit [n] if n is 1 or M.
        // [<<] disabled if n == 1
        // [>>] disabled if n == M

        let items = pageSelector$.children();

        currentPage = page;
        let rangeStart = currentPage - pageRange;
        let rangeEnd = currentPage + pageRange;
        let totalItemsUsed = 0;

        if (rangeEnd > MAX_PAGE) {
          rangeEnd = MAX_PAGE;
          rangeStart = MAX_PAGE - pageRange * 2;
          rangeStart = rangeStart < 1 ? 1 : rangeStart;
        }

        if (rangeStart <= 1) {
          rangeStart = 1;
          rangeEnd = Math.min(pageRange * 2 + 1, MAX_PAGE);
        }

        // At a minimum, increase range to 5 when possible.
        rangeEnd = Math.max(5, rangeEnd);
        rangeStart = Math.min(MAX_PAGE - 4, rangeStart);

        console.log("Current Page:", currentPage, "Range:", rangeStart, rangeEnd);

        let item = items.first();
        item.toggleClass('disabled', page == 1)
            .data('num', page - 1);
        item = item.next()
                   .toggleClass('active', page == 1)
                   .text(1).data('num', 1);
        totalItemsUsed++;
        console.log("Added FIRST_PAGE to left side. TOTAL:", totalItemsUsed);

        if (rangeStart <= 3) {
          for (i = 2; i < rangeStart; i++) {
            item = item.next()
                       .toggleClass('active', i == currentPage)
                       .removeClass('hidden disabled')
                       .text(i).data('num', i);
            totalItemsUsed++;
            console.log("Added", i, "to left side. TOTAL:", totalItemsUsed);
          }
        } else {
          item = item.next()
                     .removeClass('hidden active')
                     .addClass('disabled')
                     .text('...').removeData('num');
          totalItemsUsed++;
          console.log("Added ... to left side. TOTAL:", totalItemsUsed);
        }
        for (i = rangeStart; i <= rangeEnd; i++) {
          if (i == 1 || i ==MAX_PAGE) {
            continue;
          }
          item = item.next()
                     .toggleClass('active', i == currentPage)
                     .removeClass('disabled hidden')
                     .text(i).data('num', i);
          totalItemsUsed++;
          console.log("Added", i, "to middle. TOTAL:", totalItemsUsed);
        }
        if (rangeEnd >= MAX_PAGE - 2) {
          for (i = rangeEnd + 1; i <= MAX_PAGE - 1; i++) {
            item = item.next()
                       .toggleClass('active', i == currentPage)
                       .removeClass('hidden disabled')
                       .text(i).data('num', i);
            totalItemsUsed++;
            console.log("Added", i, "to right side. TOTAL:", totalItemsUsed);
          }
        } else {
          item = item.next()
                     .removeClass('hidden active')
                     .addClass('disabled')
                     .text('...').removeData('num');
          totalItemsUsed++;
          console.log("Added ... to right side. TOTAL:", totalItemsUsed);
        }

        item = item.next()
                   .removeClass('disabled hidden')
                   .toggleClass('active', page == MAX_PAGE)
                   .text(MAX_PAGE).data('num', MAX_PAGE);
        totalItemsUsed++;
        console.log("Added LAST_PAGE to right side. TOTAL:", totalItemsUsed);

        // Hide all remaining elements
        item = item.nextAll().addClass('hidden').removeData('num').last();
        // The last element is the ">>".
        item.removeClass('hidden')
            .toggleClass('disabled', page == MAX_PAGE)
            .data('num', page + 1);

        // Update the page contents next.

        // Deselect the current fish.

      }
    </script>

    <script type="text/javascript">
      const { interval } = rxjs;
      const { timestamp, skip } = rxjs.operators;

      $(() => {
        // Main header needs to display the current time.
        interval(1000 /*ms*/).pipe(
          timestamp()
        ).subscribe(x => {
          // Update the main header's earth and eorzea times.
          $("#earthClock").text(dateFns.format(x.timestamp, "dddd, MMMM Do YYYY, h:mm:ss a"));
          $("#eorzeaClock").text(moment.utc(eorzeaTime.toEorzea(x.timestamp)).format("HH:mm"));
        });
        let siteTheme = 'dark';
        if ('fishTrackerSettings' in window.localStorage) {
          siteTheme = JSON.parse(window.localStorage.fishTrackerSettings).theme;
        } else if ('theme' in window.localStorage) {
          siteTheme = window.localStorage.theme;
        }

        function applyTheme(theme) {
          if (theme === 'dark') {
            $('body').addClass('dark');
            $('*[data-tooltip]').attr('data-inverted', '');
          } else {
            $('body').removeClass('dark');
            $('*[data-tooltip]').removeAttr('data-inverted');
          }

          $('.ui.container').toggleClass('inverted', theme === 'dark');
          $('.ui.form').toggleClass('inverted', theme === 'dark');
          $('.ui.segment').toggleClass('inverted', theme === 'dark');
          $('.ui.table').toggleClass('inverted', theme === 'dark');
          $('.ui.list').toggleClass('inverted', theme === 'dark');
          $('.ui.top.attached.label').toggleClass('black', theme === 'dark');
          $('.ui.menu').toggleClass('inverted', theme === 'dark');
        }

        function themeButtonClicked(e) {
          if (e) e.stopPropagation();
          let $this = $(this);
          siteTheme = $this.prop('checked') ? 'dark' : 'light';
          applyTheme(siteTheme);
        }

        // Set the theme.
        $('#theme-button').prop('checked', siteTheme === 'dark');
        $('#theme-button').on('click', themeButtonClicked);
        applyTheme(siteTheme);

        // Initialize the fish guide.
        initializeFishGuide();
      });
    </script>
    <style>
      .ui.inverted.link.menu .item.disabled,
      .ui.inverted.link.menu .item.disabled:hover {
        color: rgba(225, 225, 225, 0.3);
      }

      .ui.menu .item.hidden {
        display: none;
      }
    </style>
    <style>
      .fish-guide {
        display: grid;
        grid-gap: 1em;
        grid-template-areas: "page-selector fish-info"
                             "fish-grid     fish-info";
        grid-template-columns: minmax(min-content, 360px) auto;
      }
      .page-selector {
        grid-area: page-selector;
        justify-self: center;
      }
      .tiny.menu .page-number.item {
        /* This attempts to keep the item widths uniform */
        min-width: 3.5em;
      }
      .fish-grid {
        grid-area: fish-grid;
        justify-self: center;
        display: grid;
        grid-gap: 8px;
        grid-template-columns: repeat(5, max-content);
      }
      .fish-entry {
        height: 48px;
        width: 48px;
      }
      .fish-entry.selected {
        border-radius: 8px;
        background-color: yellow;
      }
      .fish-entry .fish-icon {
        margin-top: 2px;
        margin-left: 2px;
      }
      .fish-info {
        grid-area: fish-info;
      }
    </style>
  </head>
  <body>
    <div id="topmenu" class="ui text top fixed menu">
      <div class="ui container">
        <div class="header item">FFX|V Fish Guide</div>
        <div class="right item">
          <b>Current Time:</b>&nbsp;<span id="eorzeaClock">##:##</span>&nbsp;(<span id="earthClock">#########</span>)
          <div id="theme-toogle" class="ui toggle checkbox">
            <input type="checkbox" name="theme-button" id="theme-button">
            <label></label>
          </div>
        </div>
      </div>
    </div>
    <div class="ui main container">
      <h1>FFX|V Fish Guide</h1>
      <div class="ui container">
        <div class="fish-guide">
          <div class="page-selector">
            <div class="ui tiny pagination link menu" id="fishGuidePageSelector">
              <div class="icon item"><i class="left chevron icon"></i></div>
              <div class="page-number item"></div>
              <div class="page-number item"></div>
              <div class="page-number item"></div>
              <div class="page-number item"></div>
              <div class="page-number item"></div>
              <div class="page-number item"></div>
              <div class="page-number item"></div>
              <div class="icon item"><i class="right chevron icon"></i></div>
            </div>
          </div>
          <div class="fish-grid" id="fishGuideGrid">
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
            <div class="fish-entry"><div class="fish-icon sprite-icon sprite-icon-DEFAULT"></div></div>
          </div>
          <div class="fish-info">
            <span class="fish-name">Fish Name</span><br/>
          </div>
        </div>


        <p>
          FINAL FANTASY is a registered trademark of Square Enix Holdings Co., Ltd.<br/>
          FINAL FANTASY XIV © 2010 - 2019 SQUARE ENIX CO., LTD. All Rights Reserved.
        </p>
      </div>
    </div>
    <div class="ui bottom fixed menu">
      <div class="right menu">
        <a class="icon item" href="https://discord.gg/AnFaDpN" data-tooltip="Fisherman's Horizon Discord" data-position="top right" target="_blank">
          <i class="discord icon"></i>
        </a>
        <a class="icon item" href="https://twitter.com/CarbunclePlushy" data-tooltip="Twitter" data-position="top right" target="_blank">
          <i class="twitter icon"></i>
        </a>
        <a class="icon item" href="https://github.com/icykoneko/ff14-fish-tracker-app" data-tooltip="Github" data-position="top right" target="_blank">
          <i class="github icon"></i>
        </a>
      </div>
    </div>
  </body>
</html>